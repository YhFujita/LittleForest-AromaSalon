<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>予約システム管理</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

    <style>
        body {
            background-color: #f8f9fa;
            font-family: "Helvetica Neue", Arial, sans-serif;
        }

        /* Calendar Styles */
        #calendar-container {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .fc-event {
            cursor: pointer;
            border: none !important;
        }

        .fc-daygrid-day-number {
            font-size: 1.1em;
            color: #333;
            text-decoration: none;
        }

        /* Slot Status Indicators */
        /* We will use events to show status, so specific CSS might be minimal */

        /* Modal Styles */
        .modal-slot-list {
            max-height: 50vh;
            overflow-y: auto;
        }

        .slot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .slot-item:last-child {
            border-bottom: none;
        }

        .slot-time {
            font-size: 1.1rem;
            font-weight: bold;
        }

        /* Toggle Switch Override */
        .form-switch .form-check-input {
            width: 3em;
            height: 1.5em;
            cursor: pointer;
        }

        /* Loading Overlay */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        /* Responsive Fixes */
        @media (max-width: 576px) {
            .fc-header-toolbar {
                flex-direction: column;
                gap: 10px;
            }

            .fc-toolbar-chunk {
                display: flex;
                justify-content: center;
            }
        }
    </style>
</head>

<body>

    <!-- Loading Spinner -->
    <div id="loading-overlay">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
        <div id="liveToast" class="toast align-items-center text-white bg-success border-0" role="alert"
            aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toast-message">
                    処理が完了しました
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">予約管理システム</span>
            <div id="nav-actions" class="d-none">
                <button class="btn btn-outline-light btn-sm me-2" onclick="app.refreshData()">データ更新</button>
                <button class="btn btn-outline-light btn-sm" onclick="app.logout()">ログアウト</button>
            </div>
        </div>
    </nav>

    <div class="container main-container">
        <!-- Login Section -->
        <div id="login-section" class="card shadow p-4 mx-auto" style="max-width: 400px;">
            <h3 class="text-center mb-4">管理者ログイン</h3>
            <div class="mb-3">
                <label class="form-label">ID</label>
                <input type="text" id="admin-id" class="form-control">
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" id="admin-pass" class="form-control">
            </div>
            <button class="btn btn-primary w-100 py-2" onclick="app.login()">ログイン</button>
            <div id="login-error" class="text-danger mt-3 text-center"></div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="d-none">
            <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-content"
                        type="button" role="tab">予約一覧</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="slots-tab" data-bs-toggle="tab" data-bs-target="#slots-content"
                        type="button" role="tab" onclick="app.renderSlotCalendar()">予約枠設定</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu-content"
                        type="button" role="tab" onclick="app.renderMenuSettings()">メニュー設定</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-content"
                        type="button" role="tab" onclick="app.renderBasicSettings()">基本設定</button>
                </li>
            </ul>

            <div class="tab-content">
                <!-- Reservation List -->
                <div class="tab-pane fade show active" id="list-content" role="tabpanel">
                    <div class="card p-3 shadow-sm">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">予約一覧</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>日時</th>
                                        <th>名前</th>
                                        <th>メニュー</th>
                                        <th>金額</th>
                                        <th>電話</th>
                                        <th>ステータス</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="reservation-list-body"></tbody>
                            </table>
                        </div>
                        <div id="no-reservations-msg" class="text-center text-muted p-3 d-none">予約はありません</div>
                    </div>
                </div>

                <!-- Slots (Calendar) -->
                <div class="tab-pane fade" id="slots-content" role="tabpanel">
                    <div class="card p-2 shadow-sm">
                        <div id="calendar-container">
                            <div id="slotCalendar"></div>
                        </div>
                        <div class="mt-2 text-end text-muted small">
                            日付をタップまたはクリックして時間枠を編集できます
                        </div>
                    </div>
                </div>

                <!-- Menu Settings -->
                <div class="tab-pane fade" id="menu-content" role="tabpanel">
                    <div class="card p-3 shadow-sm">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">メニュー一覧</h5>
                            <button class="btn btn-success" onclick="app.showMenuModal()">＋ 新規追加</button>
                        </div>
                        <div id="menu-list" class="list-group list-group-flush">
                            <!-- Items will be injected -->
                        </div>
                    </div>
                </div>

                <!-- Basic Settings -->
                <div class="tab-pane fade" id="settings-content" role="tabpanel">
                    <div class="card p-3 shadow-sm">
                        <h5 class="card-title mb-3">営業日時・基本設定</h5>
                        <p class="text-muted small">標準の営業時間と休憩時間を設定します。これらは予約枠カレンダーで編集する際のデフォルト値として使用されます。</p>

                        <form id="basic-settings-form">
                            <div class="mb-4 row align-items-center">
                                <label class="col-sm-3 col-form-label fw-bold">スロット間隔 (分)</label>
                                <div class="col-sm-3">
                                    <select class="form-select" id="setting-interval">
                                        <option value="30">30分</option>
                                        <option value="60">60分</option>
                                        <option value="90">90分</option>
                                        <option value="120">120分</option>
                                    </select>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-bordered align-middle text-center">
                                    <thead class="table-light">
                                        <tr>
                                            <th>曜日</th>
                                            <th style="width:100px;">状態</th>
                                            <th>開店</th>
                                            <th>閉店</th>
                                            <th>休憩開始</th>
                                            <th>休憩終了</th>
                                        </tr>
                                    </thead>
                                    <tbody id="basic-settings-tbody">
                                        <!-- JS generated -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-end mt-3">
                                <button type="button" class="btn btn-primary px-4"
                                    onclick="app.saveBasicSettings()">保存</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Slot Edit Modal -->
    <div class="modal fade" id="slotEditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- Large modal for better mobile view -->
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="slotEditModalLabel">予約枠設定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4 id="slotEditDateDisplay" class="text-center mb-4 fw-bold text-primary"></h4>
                    <p class="text-center text-muted small mb-3">スイッチをONにした時間が予約可能になります。</p>
                    <div id="slotEditList" class="modal-slot-list px-2">
                        <!-- Slots injected here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary px-4" onclick="app.saveDaySlots()">変更を保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Edit Modal -->
    <div class="modal fade" id="menuEditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="menuEditModalTitle">メニュー編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="menuId">
                    <input type="hidden" id="menuOrder">
                    <div class="mb-3">
                        <label class="form-label">メニュー名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="menuName">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">価格 (円) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="menuPrice">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">時間 (分) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="menuDuration">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">カテゴリ (セクション)</label>
                        <input type="text" class="form-control" id="menuSection" placeholder="例: オプション">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">説明</label>
                        <textarea class="form-control" id="menuDesc" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="app.saveMenu()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reservation Edit Modal -->
    <div class="modal fade" id="resEditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">予約変更</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="resId">
                    <p id="resDisplayTitle" class="fw-bold mb-3"></p>

                    <div class="mb-3">
                        <label class="form-label">日時 <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="date" class="form-control" id="resDate">
                            <input type="time" class="form-control" id="resTime">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">メニュー <span class="text-danger">*</span></label>
                        <select class="form-select" id="resMenu"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" id="resSaveBtn"
                        onclick="app.saveReservation()">変更保存</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwZw61TyYkb8fboc8mWRZGZUpzqRWUluykk2cQ4hKXQV83RySPsprsKVL9R8Luy4AbZtw/exec';

        const app = {
            token: null,
            menu: [],
            slots: [],
            reservations: [],
            basicSettings: { weekly: [], interval: 60 },
            calendar: null,
            currentEditDate: null, // YYYY-MM-DD

            // --- Auth ---
            checkAuth: function () {
                // Auto-login logic if session persisted? Not implemented yet.
                // Just default to login screen.
            },

            login: function () {
                const id = document.getElementById('admin-id').value;
                const pass = document.getElementById('admin-pass').value;
                if (!id || !pass) return alert('IDとパスワードを入力してください');

                this.showLoading(true);
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'login', id: id, password: pass })
                })
                    .then(r => r.json())
                    .then(data => {
                        this.showLoading(false);
                        if (data.status === 'success') {
                            this.token = data.token;
                            document.getElementById('login-section').classList.add('d-none');
                            document.getElementById('dashboard-section').classList.remove('d-none');
                            document.getElementById('nav-actions').classList.remove('d-none');
                            this.fetchAdminData();
                        } else {
                            document.getElementById('login-error').textContent = 'ログイン失敗: ' + data.message;
                        }
                    })
                    .catch(e => {
                        this.showLoading(false);
                        alert('Error: ' + e);
                    });
            },

            logout: function () {
                location.reload();
            },

            // --- Data Fetch ---
            fetchAdminData: function () {
                this.showLoading(true);
                fetch(GAS_URL + '?action=get_admin_data')
                    .then(r => r.json())
                    .then(data => {
                        this.showLoading(false);
                        console.log("Fetched Data:", data);
                        if (data.status === 'success') {
                            this.menu = data.menu;
                            this.slots = data.slots;
                            this.reservations = data.reservations;
                            this.basicSettings = data.basicSettings || { weekly: [], interval: 60 };

                            this.renderReservationList();
                            this.renderMenuSettings();
                            this.renderBasicSettings();

                            // If calendar is active, re-render
                            if (this.calendar) {
                                this.calendar.refetchEvents();
                            }
                        } else {
                            alert('Data Load Error: ' + data.message);
                        }
                    })
                    .catch(e => {
                        this.showLoading(false);
                        alert('Fetch Error: ' + e);
                    });
            },

            refreshData: function () {
                this.fetchAdminData();
            },

            // --- Calendar UI ---
            renderSlotCalendar: function () {
                const calendarEl = document.getElementById('slotCalendar');

                // If initializing for first time or tab switch
                if (this.calendar) {
                    this.calendar.render();
                    return;
                }

                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'ja',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: '' // Simply month view
                    },
                    height: 'auto',
                    contentHeight: 'auto',
                    fixedWeekCount: false,
                    showNonCurrentDates: false,
                    events: (fetchInfo, successCallback, failureCallback) => {
                        const events = this.getCalendarEvents();
                        successCallback(events);
                    },
                    dateClick: (info) => {
                        this.openDaySlotModal(info.dateStr);
                    },
                    eventClick: (info) => {
                        // Click on circle or status
                        const dateStr = info.event.startStr.split('T')[0];
                        this.openDaySlotModal(dateStr);
                    },
                });

                setTimeout(() => {
                    this.calendar.render();
                }, 200);
            },

            getCalendarEvents: function () {
                const dailySlots = {};
                const dailyReservationCounts = {};

                // Aggregate Slots
                if (this.slots) {
                    this.slots.forEach(slot => {
                        // "YYYY/MM/DD HH:mm"
                        const dateStr = slot.value.split(' ')[0].replace(/\//g, '-');
                        if (!dailySlots[dateStr]) dailySlots[dateStr] = 0;
                        dailySlots[dateStr]++;
                    });
                }

                // Aggregate Reservations
                if (this.reservations) {
                    this.reservations.forEach(res => {
                        if (res.status === 'キャンセル') return;
                        const dateStr = new Date(res.date).toISOString().split('T')[0]; // assuming date object parseable
                        if (!dailyReservationCounts[dateStr]) dailyReservationCounts[dateStr] = 0;
                        dailyReservationCounts[dateStr]++;
                    });
                }

                const events = [];
                const dates = new Set([...Object.keys(dailySlots), ...Object.keys(dailyReservationCounts)]);

                dates.forEach(date => {
                    const count = dailySlots[date] || 0;
                    const resCount = dailyReservationCounts[date] || 0;

                    // Available Status
                    if (count > 0) {
                        events.push({
                            title: '○',
                            start: date,
                            textColor: '#28a745',
                            backgroundColor: 'transparent',
                            borderColor: 'transparent',
                            classNames: ['fs-4', 'fw-bold', 'text-center']
                        });
                        // Optional: Show count
                        // events.push({ title: count + '枠', start: date, display:'background' });
                    } else if (resCount > 0 && count === 0) {
                        // Full? Or just no open slots but has reservations
                        events.push({
                            title: '満',
                            start: date,
                            textColor: '#dc3545', // Red
                            backgroundColor: 'transparent',
                            borderColor: 'transparent',
                            classNames: ['fs-4', 'fw-bold', 'text-center']
                        });
                    }

                    // Reservation Count Badge
                    if (resCount > 0) {
                        events.push({
                            title: resCount + '件予約',
                            start: date,
                            backgroundColor: '#ffc107',
                            borderColor: '#ffc107',
                            textColor: '#000',
                            classNames: ['small', 'px-1']
                        });
                    }
                });

                return events;
            },

            openDaySlotModal: function (dateStr) {
                this.currentEditDate = dateStr;
                const d = new Date(dateStr);
                const dayName = ['日', '月', '火', '水', '木', '金', '土'][d.getDay()];
                const dateDisplay = `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日 (${dayName})`;
                document.getElementById('slotEditDateDisplay').textContent = dateDisplay;

                const container = document.getElementById('slotEditList');
                container.innerHTML = '';

                // 1. Generate Candidates
                const dayId = d.getDay();
                const settings = this.basicSettings.weekly && this.basicSettings.weekly.find(x => x.dayId == dayId);
                const interval = parseInt(this.basicSettings.interval) || 60;

                let candidates = [];
                // Default fallback if no settings
                let startT = "10:00", endT = "20:00", bStart = "", bEnd = "";
                let isClosed = false;

                if (settings) {
                    startT = settings.startTime || "10:00";
                    endT = settings.endTime || "20:00";
                    bStart = settings.breakStart;
                    bEnd = settings.breakEnd;
                    if (settings.status === '休業') isClosed = true;
                }

                if (isClosed && (!this.slots || !this.slots.some(s => s.value.startsWith(dateStr.replace(/-/g, '/'))))) {
                    // Closed and no current slots -> Show Closed Message but allow manual add?
                    // For now, let's generate standard slots but unchecked.
                }

                // Generate time series
                const toMin = (s) => parseInt(s.split(':')[0]) * 60 + parseInt(s.split(':')[1]);
                const toTime = (m) => ('0' + Math.floor(m / 60)).slice(-2) + ':' + ('0' + (m % 60)).slice(-2);

                let cur = toMin(startT);
                let end = toMin(endT);
                let bS = bStart ? toMin(bStart) : -1;
                let bE = bEnd ? toMin(bEnd) : -1;

                // Safety loop
                let safety = 0;
                while (cur < end && safety < 100) {
                    safety++;
                    // Skip break
                    if (bS !== -1 && bE !== -1) {
                        // If time is within break
                        if (cur >= bS && cur < bE) {
                            cur += interval;
                            continue;
                        }
                    }

                    candidates.push(toTime(cur));
                    cur += interval;
                }

                // 2. Identify Status
                // "YYYY/MM/DD HH:mm"
                const activeTimes = [];
                const prefix = dateStr.replace(/-/g, '/') + ' ';
                this.slots.forEach(s => {
                    if (s.value.startsWith(prefix)) {
                        activeTimes.push(s.value.split(' ')[1]);
                    }
                });

                const reservedTimes = [];
                this.reservations.forEach(r => {
                    if (r.status === 'キャンセル') return;
                    const rd = new Date(r.date);
                    const rDateStr = rd.toISOString().split('T')[0];
                    if (rDateStr === dateStr) {
                        // Extract HH:mm
                        reservedTimes.push(toTime(rd.getHours() * 60 + rd.getMinutes()));
                    }
                });

                // Merge: 
                // Ensure all existing slots (even manually added ones not in candidates) are shown?
                // For simplicity, we stick to candidates + any active slots not in candidates
                activeTimes.forEach(t => {
                    if (!candidates.includes(t)) candidates.push(t);
                });
                candidates.sort(); // Sort times

                if (candidates.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted p-3">設定可能な枠がありません（休業日または時間外）</div>';
                }

                candidates.forEach(time => {
                    const isActive = activeTimes.includes(time);
                    // Reserved check: Fuzzy match. If a reservation starts at this time.
                    const isReserved = reservedTimes.includes(time);

                    const div = document.createElement('div');
                    div.className = 'slot-item';

                    const label = document.createElement('div');
                    label.className = 'slot-time';
                    label.textContent = time;

                    let control;
                    if (isReserved) {
                        control = document.createElement('span');
                        control.className = 'badge bg-warning text-dark';
                        control.textContent = '予約済';
                    } else {
                        const switchDiv = document.createElement('div');
                        switchDiv.className = 'form-check form-switch mb-0';

                        const input = document.createElement('input');
                        input.className = 'form-check-input slot-toggle';
                        input.type = 'checkbox';
                        input.value = time;
                        input.checked = isActive;

                        switchDiv.appendChild(input);
                        control = switchDiv;
                    }

                    div.appendChild(label);
                    div.appendChild(control);
                    container.appendChild(div);
                });

                const modal = new bootstrap.Modal(document.getElementById('slotEditModal'));
                modal.show();
            },

            saveDaySlots: function () {
                const dateStr = this.currentEditDate;
                const checks = document.querySelectorAll('.slot-toggle:checked');
                const slots = Array.from(checks).map(c => {
                    return dateStr + ' ' + c.value;
                });

                this.showLoading(true);
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update_day_slots',
                        date: dateStr,
                        slots: slots
                    })
                })
                    .then(r => r.json())
                    .then(data => {
                        this.showLoading(false);
                        if (data.status === 'success') {
                            this.showToast('予約枠を更新しました');
                            bootstrap.Modal.getInstance(document.getElementById('slotEditModal')).hide();
                            this.fetchAdminData();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    });
            },

            // --- Basic Settings UI ---
            renderBasicSettings: function () {
                const tbody = document.getElementById('basic-settings-tbody');
                tbody.innerHTML = '';
                document.getElementById('setting-interval').value = this.basicSettings.interval || 60;

                const days = this.basicSettings.weekly || [];
                // If empty, generate default structure logic already handled in backend, 
                // but if waiting for fetch, might be empty.

                days.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.dataset.dayId = d.dayId;

                    tr.innerHTML = `
                        <td class="fw-bold text-bg-light">${d.dayName}</td>
                        <td>
                            <select class="form-select form-select-sm status-select">
                                <option value="営業" ${d.status === '営業' ? 'selected' : ''}>営業</option>
                                <option value="休業" ${d.status === '休業' ? 'selected' : ''}>休業</option>
                            </select>
                        </td>
                        <td><input type="time" class="form-control form-control-sm start-time" value="${d.startTime}"></td>
                        <td><input type="time" class="form-control form-control-sm end-time" value="${d.endTime}"></td>
                        <td><input type="time" class="form-control form-control-sm break-start" value="${d.breakStart}"></td>
                        <td><input type="time" class="form-control form-control-sm break-end" value="${d.breakEnd}"></td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            saveBasicSettings: function () {
                const rows = document.querySelectorAll('#basic-settings-tbody tr');
                const weekly = Array.from(rows).map(row => {
                    return {
                        dayId: row.dataset.dayId,
                        dayName: row.cells[0].textContent,
                        status: row.querySelector('.status-select').value,
                        startTime: row.querySelector('.start-time').value,
                        endTime: row.querySelector('.end-time').value,
                        breakStart: row.querySelector('.break-start').value,
                        breakEnd: row.querySelector('.break-end').value
                    };
                });

                const interval = document.getElementById('setting-interval').value;

                this.showLoading(true);
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'save_basic_settings',
                        settings: { weekly: weekly, interval: interval }
                    })
                })
                    .then(r => r.json())
                    .then(data => {
                        this.showLoading(false);
                        if (data.status === 'success') {
                            this.showToast('基本設定を保存しました');
                            // Force refresh to update calendar view immediately if needed
                            this.fetchAdminData();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    });
            },

            // --- Menu Logic (Legacy Port) ---
            renderMenuSettings: function () {
                const list = document.getElementById('menu-list');
                list.innerHTML = '';
                this.menu.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-group-item d-flex justify-content-between align-items-center mb-1 border rounded ';

                    const priceFmt = Number(item.price).toLocaleString();

                    div.innerHTML = `
                        <div class="flex-grow-1">
                            <h5 class="mb-1 fw-bold">${item.name} <span class="badge bg-light text-dark border ms-2 small">${item.duration}分</span></h5>
                            <p class="mb-1">¥${priceFmt}</p>
                            <small class="text-muted">${item.description || ''}</small>
                            ${item.section ? '<div class="badge bg-info bg-opacity-10 text-info border border-info mt-1">' + item.section + '</div>' : ''}
                        </div>
                        <div class="ms-3 d-flex flex-column gap-2">
                             <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="app.moveMenu('${item.id}', -1)">↑</button>
                                <button class="btn btn-outline-secondary" onclick="app.moveMenu('${item.id}', 1)">↓</button>
                             </div>
                             <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick='app.openMenuEdit(${JSON.stringify(item).replace(/'/g, "&#39;")})'>編集</button>
                                <button class="btn btn-outline-danger" onclick="app.deleteMenu('${item.id}')">削除</button>
                             </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            },

            showMenuModal: function () {
                // Reset form
                document.getElementById('menuId').value = '';
                document.getElementById('menuName').value = '';
                document.getElementById('menuPrice').value = '';
                document.getElementById('menuDuration').value = '';
                document.getElementById('menuSection').value = '';
                document.getElementById('menuDesc').value = '';
                document.getElementById('menuEditModalTitle').textContent = '新規メニュー追加';

                new bootstrap.Modal(document.getElementById('menuEditModal')).show();
            },

            openMenuEdit: function (item) {
                document.getElementById('menuId').value = item.id;
                document.getElementById('menuName').value = item.name;
                document.getElementById('menuPrice').value = item.price;
                document.getElementById('menuDuration').value = item.duration;
                document.getElementById('menuSection').value = item.section || '';
                document.getElementById('menuDesc').value = item.description || '';
                document.getElementById('menuOrder').value = item.order;
                document.getElementById('menuEditModalTitle').textContent = 'メニュー編集';

                new bootstrap.Modal(document.getElementById('menuEditModal')).show();
            },

            saveMenu: function () {
                const item = {
                    id: document.getElementById('menuId').value,
                    name: document.getElementById('menuName').value,
                    price: document.getElementById('menuPrice').value,
                    duration: document.getElementById('menuDuration').value,
                    description: document.getElementById('menuDesc').value,
                    section: document.getElementById('menuSection').value,
                    order: document.getElementById('menuOrder').value
                };

                this.showLoading(true);
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'save_menu', item: item })
                }).then(() => {
                    this.showLoading(false);
                    this.showToast('メニューを保存しました');
                    bootstrap.Modal.getInstance(document.getElementById('menuEditModal')).hide();
                    this.fetchAdminData();
                });
            },

            deleteMenu: function (id) {
                if (!confirm('削除しますか？')) return;
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'delete_menu', id: id })
                }).then(() => {
                    this.showToast('削除しました');
                    this.fetchAdminData();
                });
            },

            moveMenu: function (id, dir) {
                const idx = this.menu.findIndex(x => x.id === id);
                if (idx < 0) return;
                const newIdx = idx + dir;
                if (newIdx < 0 || newIdx >= this.menu.length) return;

                const temp = this.menu[idx];
                this.menu[idx] = this.menu[newIdx];
                this.menu[newIdx] = temp;

                this.renderMenuSettings(); // Optimistic

                const ids = this.menu.map(x => x.id);
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'reorder_menu', ids: ids })
                });
            },

            // --- Reservation List Logic ---
            renderReservationList: function () {
                const tbody = document.getElementById('reservation-list-body');
                tbody.innerHTML = '';

                if (this.reservations.length === 0) {
                    document.getElementById('no-reservations-msg').classList.remove('d-none');
                } else {
                    document.getElementById('no-reservations-msg').classList.add('d-none');
                    this.reservations.forEach(res => {
                        const tr = document.createElement('tr');

                        const menu = this.menu.find(m => m.id === res.menuId);
                        const menuName = menu ? menu.name : res.menuId;
                        const isCancel = res.status === 'キャンセル';

                        if (isCancel) tr.classList.add('table-secondary', 'text-muted');

                        tr.innerHTML = `
                            <td>${res.displayDate}</td>
                            <td>${res.name}</td>
                            <td>${menuName}</td>
                            <td>${res.price ? parseInt(res.price).toLocaleString() : '-'}</td>
                            <td>${res.phone}</td>
                            <td>${isCancel ? '<span class="badge bg-secondary">キャンセル</span>' : '<span class="badge bg-success">受付</span>'}</td>
                            <td>
                                ${!isCancel ? `
                                <button class="btn btn-sm btn-outline-primary me-1" onclick='app.openResEdit(${JSON.stringify(res).replace(/'/g, "&#39;")})'>変更</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="app.cancelRes('${res.id}')">取消</button>
                                ` : ''}
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            },

            openResEdit: function (res) {
                document.getElementById('resId').value = res.id;
                document.getElementById('resDisplayTitle').textContent = `${res.displayDate} - ${res.name}様`;
                const parts = res.date.split(' ');
                document.getElementById('resDate').value = parts[0].replace(/\//g, '-');
                document.getElementById('resTime').value = parts[1];

                const sel = document.getElementById('resMenu');
                sel.innerHTML = '';
                this.menu.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.name + ' (' + m.duration + '分)';
                    if (m.id === res.menuId) opt.selected = true;
                    sel.appendChild(opt);
                });

                new bootstrap.Modal(document.getElementById('resEditModal')).show();
            },

            saveReservation: function () {
                const id = document.getElementById('resId').value;
                const d = document.getElementById('resDate').value;
                const t = document.getElementById('resTime').value;
                const m = document.getElementById('resMenu').value;

                if (!d || !t) return alert('日時を指定してください');

                const datetime = d + ' ' + t; // "YYYY-MM-DD HH:mm"

                if (!confirm('変更しますか？')) return;

                this.showLoading(true);
                const btn = document.getElementById('resSaveBtn');
                btn.disabled = true;

                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'update_reservation',
                        reservationId: id,
                        newDatetime: datetime,
                        newMenuId: m
                    })
                })
                    .then(r => r.json())
                    .then(data => {
                        this.showLoading(false);
                        btn.disabled = false;
                        if (data.status === 'success') {
                            this.showToast('変更しました');
                            bootstrap.Modal.getInstance(document.getElementById('resEditModal')).hide();
                            this.fetchAdminData();
                        } else {
                            alert('エラー: ' + data.message);
                        }
                    });
            },

            cancelRes: function (id) {
                if (!confirm('本当に取り消しますか？')) return;
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'cancel_reservation', reservationId: id })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'success') {
                            this.showToast('キャンセルしました');
                            this.fetchAdminData();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    });
            },

            showLoading: function (show) {
                document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
            },

            showToast: function (msg) {
                document.getElementById('toast-message').textContent = msg;
                var el = document.getElementById('liveToast');
                new bootstrap.Toast(el).show();
            }
        };

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            // Check auth logic / Init
            // app.login() or show login
        });
    </script>
</body>

</html>