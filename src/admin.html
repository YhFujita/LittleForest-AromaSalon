<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>予約システム管理</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background-color: #f4f4f4;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2 {
            color: #333;
        }

        .hidden {
            display: none;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #06c755;
            color: white;
            width: 100%;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.9em;
            width: auto;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            border-bottom: 2px solid #06c755;
            color: #06c755;
            font-weight: bold;
        }

        /* Lists */
        .item-list {
            list-style: none;
            padding: 0;
        }

        .item-list li {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-list li.reserved {
            background-color: #fff3cd;
            border-color: #ffeeba;
        }

        .item-info {
            flex-grow: 1;
        }

        .item-actions {
            display: flex;
            gap: 10px;
        }

        #message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            display: none;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>

    <div id="loginSection" class="container">
        <h2>管理者ログイン</h2>
        <div class="form-group">
            <label>ID</label>
            <input type="text" id="adminId">
        </div>
        <div class="form-group">
            <label>パスワード</label>
            <input type="password" id="adminPass">
        </div>
        <button class="btn-primary" onclick="login()">ログイン</button>
        <div id="loginError" style="color: red; margin-top: 10px;"></div>
    </div>

    <div id="adminPanel" class="container hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>管理画面</h1>
            <button class="btn-secondary btn-sm" onclick="logout()">ログアウト</button>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('slots')">予約枠管理</div>
            <div class="tab" onclick="switchTab('menu')">メニュー管理</div>
            <div class="tab" onclick="switchTab('reservations')">予約管理</div>
        </div>

        <!-- Slots Management -->
        <div id="slotsTab">
            <div class="form-group" style="background: #f9f9f9; padding: 15px; border-radius: 4px;">
                <h3>新規枠追加</h3>
                <input type="date" id="newSlotDate">
                <input type="time" id="newSlotTime" value="10:00" step="1800">
                <button class="btn-primary" onclick="addSlot()">追加</button>
            </div>

            <!-- Slot Edit Form (Hidden by default) -->
            <div id="slotEditForm" class="form-group hidden"
                style="background: #e9ecef; padding: 15px; border-radius: 4px; margin-top: 10px; border: 1px solid #ced4da;">
                <h3>枠の日時変更</h3>
                <p id="editingSlotTargetDisplay" style="font-weight:bold;"></p>
                <input type="hidden" id="editingSlotTargetValue">
                <label>新しい日時</label>
                <input type="date" id="editSlotDate">
                <input type="time" id="editSlotTime" step="1800">
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn-primary" onclick="saveSlotEdit()">変更保存</button>
                    <button class="btn-secondary" onclick="cancelSlotEdit()">キャンセル</button>
                </div>
            </div>

            <div id="slotsList" class="item-list">Loading...</div>
        </div>

        <!-- Menu Management -->
        <div id="menuTab" class="hidden">
            <div class="form-group" style="background: #f9f9f9; padding: 15px; border-radius: 4px;">
                <h3>メニュー追加/編集</h3>
                <input type="hidden" id="menuId">
                <input type="text" id="menuName" placeholder="メニュー名">
                <input type="number" id="menuPrice" placeholder="価格（円）">
                <input type="number" id="menuDuration" placeholder="所要時間（分）">
                <input type="text" id="menuSection" placeholder="セクションタイトル（項目の上に表示：例「コース」）">
                <textarea id="menuDesc" placeholder="説明" rows="2"></textarea>
                <input type="hidden" id="menuOrder"> <!-- Hidden, managed by list order -->
                <button class="btn-primary" onclick="saveMenu()">保存</button>
                <button class="btn-secondary hidden" id="cancelEditBtn" onclick="resetMenuForm()">キャンセル</button>
            </div>
            <div id="menuList" class="item-list">Loading...</div>
        </div>

        <!-- Reservations Management -->
        <div id="reservationsTab" class="hidden">
            <!-- Reservation Edit Form (Hidden by default) -->
            <div id="reservationEditForm" class="form-group hidden"
                style="background: #e9ecef; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #ced4da;">
                <h3>予約変更</h3>
                <p id="editingResDisplay" style="font-weight:bold;"></p>
                <input type="hidden" id="editingResId">

                <label>新しい日時</label>
                <input type="date" id="editResDate">
                <input type="time" id="editResTime" step="1800">

                <label>メニュー変更</label>
                <select id="editResMenu">
                    <!-- Populated by JS -->
                </select>

                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn-primary" onclick="saveReservationEdit()">変更保存</button>
                    <button class="btn-secondary" onclick="closeReservationEdit()">キャンセル</button>
                </div>
            </div>

            <div id="reservationsList" class="item-list">Loading...</div>
        </div>
    </div>

    <div id="message"></div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwZw61TyYkb8fboc8mWRZGZUpzqRWUluykk2cQ4hKXQV83RySPsprsKVL9R8Luy4AbZtw/exec'; // Replace with your Web App URL if changed

        function showMessage(msg, isError = false) {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = isError ? 'error' : 'success';
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // --- Auth ---
        function login() {
            const id = document.getElementById('adminId').value;
            const pass = document.getElementById('adminPass').value;

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'login', id: id, password: pass })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        localStorage.setItem('admin_token', 'valid'); // Simple session
                        showPanel();
                        loadData();
                    } else {
                        document.getElementById('loginError').textContent = 'ログインに失敗しました';
                    }
                })
                .catch(err => alert('Error: ' + err));
        }

        function logout() {
            localStorage.removeItem('admin_token');
            location.reload();
        }

        function checkAuth() {
            if (localStorage.getItem('admin_token')) {
                document.getElementById('adminId').value = ''; // Clear fields
                document.getElementById('adminPass').value = '';
                showPanel();
                loadData();
            }
        }

        function showPanel() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        // --- Data Loading ---
        let currentSlots = [];
        let currentMenu = [];
        let currentReservations = [];

        function loadData() {
            // Fetch all data including admin specific view if possible
            fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'get_admin_data' }) })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentMenu = data.menu;
                        currentSlots = data.slots;
                        currentReservations = data.reservations || [];
                        renderSlots();
                        renderMenu();
                        renderReservations();
                    }
                });
        }

        // --- Tabs ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'slots') {
                document.getElementById('slotsTab').classList.remove('hidden');
                document.getElementById('menuTab').classList.add('hidden');
                document.getElementById('reservationsTab').classList.add('hidden');
            } else if (tabName === 'menu') {
                document.getElementById('slotsTab').classList.add('hidden');
                document.getElementById('menuTab').classList.remove('hidden');
                document.getElementById('reservationsTab').classList.add('hidden');
            } else if (tabName === 'reservations') {
                document.getElementById('slotsTab').classList.add('hidden');
                document.getElementById('menuTab').classList.add('hidden');
                document.getElementById('reservationsTab').classList.remove('hidden');
            }
        }

        // --- Slots ---
        function renderSlots() {
            const list = document.getElementById('slotsList');
            list.innerHTML = '';
            currentSlots.forEach(slot => {
                const li = document.createElement('li');
                li.innerHTML = `
            <div class="item-info">
                <strong>${slot.display}</strong>
                <br>
                <span style="font-size:0.8em; color: gray;">${slot.value}</span>
            </div>
            <div class="item-actions">
                <button class="btn-sm btn-secondary" onclick="openSlotEdit('${slot.value}', '${slot.display}')">編集</button>
                <button class="btn-sm btn-danger" onclick="deleteSlot('${slot.value}')">削除</button>
            </div>
            `;
                list.appendChild(li);
            });
        }

        function openSlotEdit(value, display) {
            document.getElementById('slotEditForm').classList.remove('hidden');
            document.getElementById('editingSlotTargetDisplay').textContent = "変更対象: " + display;
            document.getElementById('editingSlotTargetValue').value = value;

            // Parse current value (yyyy/MM/dd HH:mm) to set default inputs
            // "2026/01/30 10:00"
            const parts = value.split(' ');
            if (parts.length === 2) {
                document.getElementById('editSlotDate').value = parts[0].replace(/\//g, '-');
                document.getElementById('editSlotTime').value = parts[1];
            }
            window.scrollTo(0, 0);
        }

        function cancelSlotEdit() {
            document.getElementById('slotEditForm').classList.add('hidden');
            document.getElementById('editingSlotTargetValue').value = '';
        }

        function saveSlotEdit() {
            const currentDatetime = document.getElementById('editingSlotTargetValue').value;
            const newDate = document.getElementById('editSlotDate').value;
            const newTime = document.getElementById('editSlotTime').value;

            if (!newDate || !newTime) {
                alert('日付と時間を入力してください');
                return;
            }

            const newDatetime = newDate + ' ' + newTime; // Needs to be constructed as valid Date string

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'update_slot_datetime',
                    currentDatetime: currentDatetime,
                    newDatetime: newDatetime
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        showMessage('日時を変更しました');
                        cancelSlotEdit();
                        loadData();
                    } else {
                        showMessage('エラー: ' + data.message, true);
                    }
                });
        }

        function addSlot() {
            const d = document.getElementById('newSlotDate').value;
            const t = document.getElementById('newSlotTime').value;
            if (!d || !t) {
                alert('日付と時間を入力してください');
                return;
            }

            // Convert YYYY-MM-DD to YYYY/MM/DD for better compatibility with GAS new Date()
            const dateTimeStr = d.replace(/-/g, '/') + ' ' + t;

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'add_slots', slots: [dateTimeStr] })
            }).then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        showMessage('追加しました');
                        loadData();
                    } else {
                        showMessage('エラー: ' + (data.message || 'Unknown'), true);
                    }
                });
        }

        function deleteSlot(val) {
            if (!confirm('本当に削除しますか？')) return;
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'delete_slot', datetime: val })
            }).then(() => {
                showMessage('削除しました', true);
                loadData(); // Reload all data after deletion
            });
        }

        // --- Menu ---
        function renderMenu() {
            const list = document.getElementById('menuList');
            list.innerHTML = '';
            currentMenu.forEach(item => {
                const li = document.createElement('li');
                // Format price with commas
                const priceFormatted = Number(item.price).toLocaleString();

                // Section Header if present
                if (item.section) {
                    const sectionHeader = document.createElement('div');
                    sectionHeader.style.cssText = 'background:#eee; padding:5px 10px; font-weight:bold; margin-top:10px; border-radius:4px;';
                    sectionHeader.textContent = item.section;
                    list.appendChild(sectionHeader);
                }

                li.innerHTML = `
                <div class="item-info">
                    <strong>${item.name}</strong> (${priceFormatted}円 / ${item.duration}分)
                    <br><small>${item.description}</small>
                    ${item.section ? '<br><span style="font-size:0.8em; color:blue;">[セクション始点: ' + item.section + ']</span>' : ''}
                </div>
                <div class="item-actions" style="flex-direction: column; gap: 5px;">
                    <div style="display:flex; gap:5px;">
                         <button class="btn-sm btn-secondary" onclick="moveMenu(event, '${item.id}', -1)">↑</button>
                         <button class="btn-sm btn-secondary" onclick="moveMenu(event, '${item.id}', 1)">↓</button>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-sm btn-secondary" onclick='editMenu(${JSON.stringify(item)})'>編集</button>
                        <button class="btn-sm btn-danger" onclick="deleteMenu('${item.id}')">削除</button>
                    </div>
                </div>
            `;
                list.appendChild(li);
            });
        }

        function editMenu(item) {
            document.getElementById('menuId').value = item.id;
            document.getElementById('menuName').value = item.name;
            document.getElementById('menuPrice').value = item.price;
            document.getElementById('menuDuration').value = item.duration;
            document.getElementById('menuSection').value = item.section || '';
            document.getElementById('menuDesc').value = item.menuDesc || item.description;
            document.getElementById('menuOrder').value = item.order; // Preserve order
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function resetMenuForm() {
            document.getElementById('menuId').value = '';
            document.getElementById('menuName').value = '';
            document.getElementById('menuPrice').value = '';
            document.getElementById('menuDuration').value = '';
            document.getElementById('menuSection').value = '';
            document.getElementById('menuDesc').value = '';
            document.getElementById('menuOrder').value = '';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        function saveMenu() {
            const item = {
                id: document.getElementById('menuId').value,
                name: document.getElementById('menuName').value,
                price: document.getElementById('menuPrice').value,
                duration: document.getElementById('menuDuration').value,
                description: document.getElementById('menuDesc').value,
                section: document.getElementById('menuSection').value,
                order: document.getElementById('menuOrder').value // Keep existing if editing, or will be appended
            };

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'save_menu', item: item })
            }).then(() => {
                showMessage('保存しました');
                resetMenuForm();
                loadData();
            });
        }

        function deleteMenu(id) {
            if (!confirm('本当に削除しますか？')) return;
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'delete_menu', id: id })
            }).then(() => {
                showMessage('削除しました', true);
                loadData();
            });
        }

        function moveMenu(e, id, direction) {
            e.stopPropagation();
            const index = currentMenu.findIndex(item => item.id == id);
            if (index < 0) return;

            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentMenu.length) return;

            // Swap
            const temp = currentMenu[index];
            currentMenu[index] = currentMenu[newIndex];
            currentMenu[newIndex] = temp;

            // Optimistic UI Update
            renderMenu();

            // Save new order to backend
            const ids = currentMenu.map(item => item.id);
            // Debounce or just save? For simplicity, save immediately.
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'reorder_menu', ids: ids })
            }).then(res => res.json())
                .then(data => {
                    if (data.status !== 'success') {
                        alert('並び替えの保存に失敗しました');
                        loadData(); // Revert
                    }
                });
        }

        // --- Reservations ---
        function renderReservations() {
            const list = document.getElementById('reservationsList');
            list.innerHTML = '';

            // Filter out past? Optional. Showing all for now.
            // Highlight Cancelled.

            currentReservations.forEach(res => {
                const li = document.createElement('li');
                const isCancelled = res.status === 'キャンセル';

                // Find menu name
                const menu = currentMenu.find(m => m.id === res.menuId);
                const menuName = menu ? menu.name : '不明なメニュー';

                if (isCancelled) {
                    li.style.backgroundColor = '#f0f0f0';
                    li.style.color = '#999';
                }

                li.innerHTML = `
                <div class="item-info">
                    <strong>${res.displayDate}</strong> ${isCancelled ? '<span style="color:red">[キャンセル済]</span>' : ''}
                    <br>
                    ${res.name} 様 (${menuName})
                    <br>
                    <small>電話: ${res.phone} / 備考: ${res.notes || 'なし'}</small>
                </div>
                <div class="item-actions">
                    ${!isCancelled ? `
                    <button class="btn-sm btn-secondary" onclick='openReservationEdit(${JSON.stringify(res)})'>変更</button>
                    <button class="btn-sm btn-danger" onclick="cancelReservationAction('${res.id}')">取消</button>
                    ` : ''}
                </div>
                `;
                list.appendChild(li);
            });

            if (currentReservations.length === 0) {
                list.innerHTML = '<p style="text-align:center; color:gray;">予約はありません</p>';
            }
        }

        function openReservationEdit(res) {
            document.getElementById('reservationEditForm').classList.remove('hidden');
            document.getElementById('editingResId').value = res.id;
            document.getElementById('editingResDisplay').textContent = `${res.displayDate} - ${res.name}様`;

            // Setup Date/Time inputs
            // res.date is "YYYY/MM/DD HH:mm"
            const parts = res.date.split(' ');
            if (parts.length === 2) {
                document.getElementById('editResDate').value = parts[0].replace(/\//g, '-');
                document.getElementById('editResTime').value = parts[1];
            }

            // Setup Menu Select
            const select = document.getElementById('editResMenu');
            select.innerHTML = '';
            currentMenu.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.name + ' (' + m.duration + '分)';
                if (m.id === res.menuId) opt.selected = true;
                select.appendChild(opt);
            });

            window.scrollTo(0, 0); // Scroll to top to see form
        }

        function closeReservationEdit() {
            document.getElementById('reservationEditForm').classList.add('hidden');
        }

        function saveReservationEdit() {
            const id = document.getElementById('editingResId').value;
            const newDate = document.getElementById('editResDate').value; // YYYY-MM-DD
            const newTime = document.getElementById('editResTime').value; // HH:mm
            const newMenuId = document.getElementById('editResMenu').value;

            if (!newDate || !newTime) {
                alert('日時を入力してください');
                return;
            }

            const newDatetime = newDate.replace(/-/g, '/') + ' ' + newTime;

            if (!confirm('変更を保存しますか？\n（カレンダーも更新されます）')) return;

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'update_reservation',
                    reservationId: id,
                    newDatetime: newDatetime,
                    newMenuId: newMenuId
                })
            }).then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        showMessage('予約を変更しました');
                        closeReservationEdit();
                        loadData(); // Reload
                    } else {
                        showMessage('エラー: ' + data.message, true);
                    }
                });
        }

        function cancelReservationAction(id) {
            if (!confirm('本当にこの予約を取り消しますか？\n（カレンダーからも削除されます）')) return;

            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'cancel_reservation', reservationId: id })
            }).then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        showMessage('予約を取り消しました', true); // Show as 'success' style visually but maybe red message
                        loadData();
                    } else {
                        showMessage('エラー: ' + data.message, true);
                    }
                });
        }


        renderSlots();


        // Init
        checkAuth();

    </script>
</body>

</html>